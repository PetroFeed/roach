#!/usr/bin/env node

var _ = require('lodash');
var program = require('commander');
var path = require('path');
var resolve = path.resolve;
var join = path.join;
var fs = require('fs');
var spawn = require('win-fork');
var exists = fs.existsSync;


/**
 * Usage.
 */

program
  .version(require('../package.json').version)
  .usage('<command> [options]')
  .option('-r, --redis', 'set redis authentication config')
  // .option('-c, --crawlers', 'set path to the root crawlers directory')
  .option('-s, --server', 'run roach in server mode');


/**
 * Examples.
 */

program.on('--help', function () {
  console.log('  Commands:');
  console.log();
  console.log('    create [dir]       scaffold a roach crawler in the given directory');
  console.log('    run                run the roach server');
  console.log();
});


/**
 * Parse.
 */

program.parse(process.argv);

// args void of cmd

var args = process.argv.slice(3);

// command

var cmd = program.args[0];

// executable

var bin = 'roach-' + cmd;

// local or resolve to absolute executable path

var local = join(__dirname, bin);


function spawnCmd(options) {

  if (exists(local)) {
    bin = local;
  }
  
  // display help if bin does not exist

  if (!exists(bin)) {
    console.error('\n  %s"(1)"" is not a valid roach command', bin);
    program.help();
  }

  // spawn
  var proc = spawn(bin, _.isEmpty(options) ? [] : [JSON.stringify(options)], { stdio: 'inherit', customFds: [0, 1, 2] });

  proc.on('close', function(code){
    process.exit(code);
  });

}

var options = {};

if (program.redis) {

  var prompt = {
    port: 'port (default: 6379) : ',
    host: 'host (default: 127.0.0.1) : '
  };

  // prompt

  program.prompt(prompt, function(obj){
    options.redis = {
      port: obj.port || 6379,
      host: obj.host || '127.0.0.1'
    };
  });

}

if (program.server) {
  var prompt = {
    port: 'port (default: 5000) : ',
    host: 'host (default: 127.0.0.1) : '
  };

  // prompt

  program.prompt(prompt, function(obj){
    options.server = {
      port: obj.port || 6379,
      host: obj.host || '127.0.0.1',
      run: true
    };
  });
}

spawnCmd(options);



